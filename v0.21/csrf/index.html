<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>http4s | CSRF</title>

  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.21/css/bootstrap.min.css" >  
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.21/css/font-awesome.min.css" >  
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.21/css/fontello.css" >
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Share+Tech" >
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.21/css/highlight-github.css">
  <link rel="stylesheet" type="text/css" href="https://http4s.org/v0.21/css/style.css" >
</head>

  <body>
    <nav class="navbar navbar-expand-md fixed-top navbar-dark bg-secondary">
      <div class="container">
      <a class="navbar-brand" href="/">
        http4s<img src="/images/http4s-logo.svg" alt="logo" class="logo" />
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fa fa-navicon"></i>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="https://http4s.org/#" id="docs-menu-item" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Documentation
          </a>
          <div class="dropdown-menu" aria-labelledby="doc-menu-item">
  <a class="dropdown-item" href="/v0.21/">v0.21 (dev)</a>  
  <a class="dropdown-item" href="/v0.20/">v0.20 (stable)</a>
  <a class="dropdown-item" href="/v0.19/">v0.19 (EOL)</a>
  <a class="dropdown-item" href="/v0.18/">v0.18 (EOL)</a>
  <a class="dropdown-item" href="/v0.17/">v0.17 (EOL)</a>
  <a class="dropdown-item" href="/v0.16/">v0.16 (EOL)</a>
  <a class="dropdown-item" href="/versions/">Help me choose...</a>
</div>

        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="https://http4s.org/#" id="projects-menu-item" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Projects
          </a>
          <div class="dropdown-menu" aria-labelledby="projects-menu-item"> 
            <a class="dropdown-item" href="/">http4s</a>
            <a class="dropdown-item" href="https://github.com/http4s/blaze">blaze</a>
            <a class="dropdown-item" href="https://jdk-http-client.http4s.org/">http4s-jdk-http-client</a>
            <a class="dropdown-item" href="https://github.com/http4s/rho">rho</a>
          </div>
        </li>
        </ul>
        <ul class="navbar-nav" id="http4s-social">
        <li class="nav-item"><a class="nav-link" href="https://github.com/http4s/http4s" title="http4s/http4s on GitHub"><span class="icon-github-circled"></span></a></li>	
        <li class="nav-item"><a class="nav-link" href="https://gitter.im/http4s/http4s" title="http4s/http4s on Gitter"><span class="icon-gitter" aria-hidden="true"></span></a></li>
        <li class="nav-item"><a class="nav-link" href="https://twitter.com/http4s" title="@http4s on Twitter"><span class="icon-twitter" aria-hidden="true"></span></a></li>
        </ul>
        
      </div>
    </nav>

    <div class="container">

      <div class="row row-offcanvas row-offcanvas-right">

        <div class="col-12 col-md-9 order-1">
          <span class="float-right">
          
<a href="https://github.com/http4s/http4s/edit/series/0.21/docs/src/main/tut/csrf.md" class="btn btn-secondary btn-sm">
  <i class="fa fa-edit"></i>
</a>

          <span class="d-md-none">
            <button type="button" class="btn btn-secondary btn-sm" data-toggle="offcanvas">
              <i class="fa fa-navicon"></i>
            </button>
          </span>
          </span>

          
          <h1>CSRF</h1>
          
          
          <p>Http4s provides <a href="../middleware">Middleware</a>, named <code>CSRF</code>, to prevent Cross-site request forgery attacks. This middleware
is modeled after the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">double submit cookie pattern</a>.</p>

<p>Examples in this document have the following dependencies.</p>

<pre><code class="language-scala">libraryDependencies ++= Seq(
  &quot;org.http4s&quot; %% &quot;http4s-dsl&quot; % http4sVersion,
  &quot;org.http4s&quot; %% &quot;http4s-server&quot; % http4sVersion
)
</code></pre>

<p>And we need some imports.</p>

<pre><code class="language-scala">  import cats.effect._
  import org.http4s._
  import org.http4s.dsl.io._
  import org.http4s.implicits._
  import org.http4s.headers.Referer
  import org.http4s.server.middleware._
</code></pre>

<p>Let&rsquo;s start by making a simple service.</p>

<pre><code class="language-scala">val service = HttpRoutes.of[IO] {
  case _ =&gt;
    Ok()
} 
// service: org.http4s.HttpRoutes[cats.effect.IO] = Kleisli(org.http4s.HttpRoutes$$$Lambda$36412/351566147@2e8c9402)

val request = Request[IO](Method.GET, uri&quot;/&quot;)
// request: org.http4s.Request[cats.effect.IO] = Request(method=GET, uri=/, headers=Headers())

service.orNotFound(request).unsafeRunSync
// res0: org.http4s.Response[cats.effect.IO] = Response(status=200, headers=Headers(Content-Length: 0))
</code></pre>

<p>That didn&rsquo;t do all that much. Lets build out our CSRF Middleware by creating a <code>CSRFBuilder</code></p>

<pre><code class="language-scala">val cookieName = &quot;csrf-token&quot;
val key  = CSRF.generateSigningKey[IO].unsafeRunSync
val defaultOriginCheck: Request[IO] =&gt; Boolean =
  CSRF.defaultOriginCheck[IO](_, &quot;localhost&quot;, Uri.Scheme.http, None)
val csrfBuilder = CSRF[IO,IO](key, defaultOriginCheck)
</code></pre>

<p>More info on what is possible in the <a href="../api/org/http4s/server/middleware/csrf$$csrfbuilder">CSRFBuilder</a> Docs,
but we will create a fairly simple CSRF Middleware in our example.</p>

<pre><code class="language-scala">val csrf = csrfBuilder.withCookieName(cookieName).withCookieDomain(Some(&quot;localhost&quot;)).withCookiePath(Some(&quot;/&quot;)).build
// csrf: org.http4s.server.middleware.CSRF[cats.effect.IO,cats.effect.IO] = org.http4s.server.middleware.CSRF@4b6effa0
</code></pre>

<p>Now we need to wrap this around our service! We&rsquo;re gonna start with a safe call</p>

<pre><code class="language-scala">val dummyRequest: Request[IO] =
    Request[IO](method = Method.GET).putHeaders(Header(&quot;Origin&quot;, &quot;http://localhost&quot;))
// dummyRequest: org.http4s.Request[cats.effect.IO] = Request(method=GET, uri=/, headers=Headers(Origin: http://localhost))

val resp = csrf.validate()(service.orNotFound)(dummyRequest).unsafeRunSync()
// resp: org.http4s.Response[cats.effect.IO] = Response(status=200, headers=Headers(Content-Length: 0, Set-Cookie: &lt;REDACTED&gt;))
</code></pre>

<p>Notice how the response has the CSRF cookies added. How easy was
that? And, as described in <a href="../middleware">Middleware</a>, services and middleware can be
composed such that only some of your endpoints are CSRF enabled. By default,
safe methods will update the CSRF token, while unsafe methods will validate them.</p>

<p>Without getting too deep into it, safe methods are OPTIONS, GET, and HEAD. While unsafe methods are
POST, PUT, PATCH, DELETE, and TRACE. To put it simply, state changing methods are unsafe. For more information,
check out this cheat sheet on <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">CSRF Prevention</a>.</p>

<p>Unsafe requests (like POST) require us to send the CSRF token in the <code>X-Csrf-Token</code>
header (this is the default name, but it can be changed), so we are going to get the value
and send it up in our POST. I&rsquo;ve also added the response cookie as a RequestCookie, normally
the browser would send this up with our request, but I needed to do it manually for the purpose of this demo.</p>

<pre><code class="language-scala">val cookie = resp.cookies.head
// cookie: org.http4s.ResponseCookie = csrf-token=C0527F8899DE60994155796E6C7338E6CB395194FE83B0A23AB74E227CE20CF1-1574670706787-72773B2E833ACB5FD780F95A2CB33D66DA722D3A; Domain=localhost; Path=/; HttpOnly

val dummyPostRequest: Request[IO] =
    Request[IO](method = Method.POST).putHeaders(
      Header(&quot;Origin&quot;, &quot;http://localhost&quot;),
      Header(&quot;X-Csrf-Token&quot;, cookie.content)
    ).addCookie(RequestCookie(cookie.name,cookie.content))
// dummyPostRequest: org.http4s.Request[cats.effect.IO] = Request(method=POST, uri=/, headers=Headers(Origin: http://localhost, X-Csrf-Token: C0527F8899DE60994155796E6C7338E6CB395194FE83B0A23AB74E227CE20CF1-1574670706787-72773B2E833ACB5FD780F95A2CB33D66DA722D3A, Cookie: &lt;REDACTED&gt;))

val resp = csrf.validate()(service.orNotFound)(dummyPostRequest).unsafeRunSync()
// resp: org.http4s.Response[cats.effect.IO] = Response(status=200, headers=Headers(Content-Length: 0, Set-Cookie: &lt;REDACTED&gt;))
</code></pre>

        </div>

        <div class="col-6 col-md-3 order-2 sidebar-offcanvas p-0" id="sidebar">
          <ul class="nav flex-column">          
            
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/">Quick Start</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/upgrading/">Upgrading from 0.18</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/service/">Service</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/dsl/">The http4s DSL</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/middleware/">Middleware</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/auth/">Authentication</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/cors/">CORS</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link active" href="/v0.21/csrf/">CSRF</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/gzip/">GZip Compression</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/hsts/">HSTS</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/static/">Static Files</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/client/">HTTP Client</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/entity/">Entity handling</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/streaming/">Streaming</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/json/">JSON handling</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/testing/">Testing</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/uri/">URI handling</a>
            </li>
            
            <li class="nav-item">
	      <a class="nav-link" href="/v0.21/api">Scaladoc</a>
            </li>
            
          </ul>
        </div>
      </div>
      <hr />
      <footer class="text-muted text-center small">
        http4s is a <a href="https://typelevel.org/">Typelevel</a> Incubator Project distributed under the <a href="https://github.com/http4s/http4s/LICENSE">Apache 2 License</a>.
      </footer>

    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
<script src="https://http4s.org/v0.21/js/highlight.pack.js"></script>
<script>
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function () {
    $('[data-toggle="offcanvas"]').click(function () {
      $('.row-offcanvas').toggleClass('active')
    });
  });

  $('h2').each(function() { $(this).prepend('<a href=#' + $(this).context.id + '>:link: </a>') })  
</script>

  </body>
</html>


